from django.shortcuts import render
from django.contrib.auth.models import User
from django.db.models import Q
from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework import status


from gamesManager.models import Game
from userprofile.models import Profile
from authentication.manageTokens import get_token_user
from authentication.decorator import require_authorization


def get_image(user):
    profile_user = Profile.objects.all().filter(user__id=user.id)
    try:
        profile_user = profile_user[0]
    except Exception as e:
        usrImg = "/images/avatar.png"
        return usrImg

    if len(profile_user.profile_picture) == 0:
        usrImg = "/images/avatar.png"
    else:
        usrImg = profile_user["profile_picture"]
    return usrImg

def get_games_history(games, user):
    retval = dict()
    usrImg = get_image(user)
    for game in games:
        player2 = game.player2
        player2_user = User.objects.get(username=player2)
        user2_img = get_image(player2_user)
        retval["player1"] = game.player1
        retval["player2"] = player2
        if len(game.score_player1) == 0:
            retval["score_player1"] = 0
        else:
            retval["score_player1"] = int(game.score_player1)
        if len(game.score_player2) == 0:
            retval["score_player2"] = 0
        else:
            retval["score_player2"] = int(game.score_player2)
        retval["time"] = game.time
        if game.player1 == user.username:
            retval["avatar1"] = usrImg
            retval["avatar2"] = user2_img
        else:
            retval["avatar2"] = usrImg
            retval["avatar1"] = user2_img

@api_view(["GET"])
@require_authorization
def get_profile(request):
    username = get_token_user(request.headers["Authorization"])
    user = User.objects.get(username=username)
    games = Game.objects.all().filter(Q(player1__id=user.id) |
                                    Q(player2__id=user.id))

    games_history = get_games_history(games, user)
    print("sending:", games_history)
    return Response(games_history, status.HTTP_200_OK)
